<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="screen-orientation" content="portrait">
    <meta name="orientation" content="portrait">
    <title>Chaturvedi Classes - NCERT Library</title>
    <!-- Load necessary libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel is needed to process the JSX inside the script tag -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8P6IzzXC9eXpOyJsJthV21s1bbL4kEKQ",
            authDomain: "classes-cfb71.firebaseapp.com",
            databaseURL: "https://classes-cfb71-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "classes-cfb71",
            storageBucket: "classes-cfb71.firebasestorage.app",
            messagingSenderId: "678474968676",
            appId: "1:678474968676:web:9644c9bc6380c857983971"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Make Firebase available globally
        window.firebaseAuth = firebase.auth();
        window.firebaseDb = firebase.firestore();

        // Enable Firestore persistence for faster offline access
        try {
            firebase.firestore().enablePersistence().catch(err => {
                console.log("Firestore persistence not available:", err);
            });
        } catch (e) {
            console.log("Firestore persistence error:", e);
        }
    </script>
    
    <style>
        /* Custom styles and font import */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Utility to hide scrollbar on mobile */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
    </style>
    
    <!-- Orientation Lock Script -->
    <script>
        // Lock orientation to portrait
        function lockOrientation() {
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('portrait').catch((err) => {
                    console.log('Orientation lock failed:', err);
                });
            } else if (screen.lockOrientation) {
                screen.lockOrientation('portrait');
            } else if (screen.mozLockOrientation) {
                screen.mozLockOrientation('portrait');
            } else if (screen.msLockOrientation) {
                screen.msLockOrientation('portrait');
            }
        }
        
        // Try to lock on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', lockOrientation);
        } else {
            lockOrientation();
        }
        
        // Also try on orientation change
        window.addEventListener('orientationchange', () => {
            setTimeout(lockOrientation, 100);
        });
    </script>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Inline Icons (Replaces Lucide dependency for better stability) ---
        const Icons = {
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            ExternalLink: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>,
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="9 18 15 12 9 6"/></svg>,
            Library: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m16 6 4 14"/><path d="M12 6v14"/><path d="M8 8v12"/><path d="M4 4v16"/></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>,
            Book: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            GraduationCap: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>,
            ArrowLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="19" x2="5" y1="12" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
            Menu: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            User: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Eye: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" x2="23" y1="1" y2="23"/></svg>,
            LogOut: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Edit: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Phone: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            MapPin: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Grid: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            Share2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>,
            Bell: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>,
            Bot: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="11" width="18" height="10" rx="2" ry="2"/><circle cx="12" cy="16" r="1"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>,
            ChevronLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="15 18 9 12 15 6"/></svg>,
        };

        const { Download, ExternalLink, ChevronRight, ChevronLeft, Library, Search, Book, GraduationCap, ArrowLeft, Menu, Lock, User, Eye, EyeOff, LogOut, Edit, Phone, MapPin, FileText, Grid, Star, Share2, Bell, Bot, Sparkles } = Icons;

        // --- Data Configuration (Moved outside component for clarity, but remains in the HTML file) ---
        const NCERT_DATA = {
            9: [
                { 
                    title: "Mathematics", 
                    code: "iemh1", 
                    cover: "blue",
                    chapters: [
                        "Number Systems", "Polynomials", "Coordinate Geometry", "Linear Equations in Two Variables", 
                        "Introduction to Euclid's Geometry", "Lines and Angles", "Triangles", "Quadrilaterals", 
                        "Circles", "Heron's Formula", "Surface Areas and Volumes", "Statistics"
                    ]
                },
                { 
                    title: "Science", 
                    code: "iesc1", 
                    cover: "emerald",
                    chapters: [
                        "Matter in Our Surroundings", "Is Matter Around Us Pure?", "Atoms and Molecules", "Structure of the Atom",
                        "The Fundamental Unit of Life", "Tissues", "Motion", "Force and Laws of Motion", 
                        "Gravitation", "Work and Energy", "Sound", "Improvement in Food Resources"
                    ]
                },
                { title: "Beehive (English)", code: "iebe1", count: 11, cover: "orange" },
                { title: "Moments (English)", code: "iemo1", count: 10, cover: "orange" },
                { title: "Democratic Politics", code: "iess4", count: 5, cover: "red" },
                { title: "Contemporary India", code: "iess1", count: 6, cover: "yellow" },
                { title: "Economics", code: "iess2", count: 4, cover: "pink" },
                { title: "India & Contemp. World", code: "iess3", count: 5, cover: "purple" },
            ],
            10: [
                { 
                    title: "Mathematics", 
                    code: "jemh1", 
                    cover: "blue",
                    chapters: [
                        "Real Numbers", "Polynomials", "Pair of Linear Equations in Two Variables", "Quadratic Equations",
                        "Arithmetic Progressions", "Triangles", "Coordinate Geometry", "Introduction to Trigonometry",
                        "Some Applications of Trigonometry", "Circles", "Areas Related to Circles", "Surface Areas and Volumes",
                        "Statistics", "Probability"
                    ]
                },
                { 
                    title: "Science", 
                    code: "jesc1", 
                    cover: "emerald",
                    chapters: [
                        "Chemical Reactions and Equations", "Acids, Bases and Salts", "Metals and Non-metals", "Carbon and Its Compounds",
                        "Life Processes", "Control and Coordination", "How Do Organisms Reproduce?", "Heredity",
                        "Light – Reflection and Refraction", "The Human Eye and the Colourful World", "Electricity", "Magnetic Effects of Electric Current",
                        "Our Environment"
                    ]
                },
                { title: "First Flight (English)", code: "jeff1", count: 11, cover: "orange" },
                { title: "Footprints (English)", code: "jefp1", count: 10, cover: "orange" },
                { title: "Democratic Politics II", code: "jess4", count: 5, cover: "red" },
                { title: "Contemporary India II", code: "jess1", count: 7, cover: "yellow" },
                { title: "Economics", code: "jess2", count: 5, cover: "pink" },
                { title: "India & Contemp. World II", code: "jess3", count: 5, cover: "purple" },
            ],
            11: [
                { 
                    title: "Mathematics", 
                    code: "kemh1", 
                    cover: "blue",
                    chapters: [
                        "Sets", "Relations and Functions", "Trigonometric Functions", "Principle of Mathematical Induction",
                        "Complex Numbers and Quadratic Equations", "Linear Inequalities", "Permutations and Combinations", "Binomial Theorem",
                        "Sequences and Series", "Straight Lines", "Conic Sections", "Introduction to Three Dimensional Geometry",
                        "Limits and Derivatives", "Mathematical Reasoning", "Statistics", "Probability"
                    ]
                },
                { 
                    title: "Biology", 
                    code: "kebo1", 
                    cover: "green",
                    chapters: [
                        "The Living World", "Biological Classification", "Plant Kingdom", "Animal Kingdom",
                        "Morphology of Flowering Plants", "Anatomy of Flowering Plants", "Structural Organisation in Animals", "Cell: The Unit of Life",
                        "Biomolecules", "Cell Cycle and Cell Division", "Photosynthesis in Higher Plants", "Respiration in Plants",
                        "Plant Growth and Development", "Breathing and Exchange of Gases", "Body Fluids and Circulation", "Excretory Products and their Elimination",
                        "Locomotion and Movement", "Neural Control and Coordination", "Chemical Coordination and Integration"
                    ]
                },
                { title: "Physics Part I", code: "keph1", count: 8, cover: "indigo" },
                { title: "Physics Part II", code: "keph2", count: 7, cover: "indigo" },
                { title: "Chemistry Part I", code: "kech1", count: 7, cover: "teal" },
                { title: "Chemistry Part II", code: "kech2", count: 7, cover: "teal" },
                { title: "Hornbill (English)", code: "kehb1", count: 8, cover: "orange" },
                { title: "Snapshot (English)", code: "kesp1", count: 8, cover: "orange" },
            ],
            12: [
                { 
                    title: "Mathematics Part I", 
                    code: "lemh1", 
                    cover: "blue",
                    chapters: [
                        "Relations and Functions", "Inverse Trigonometric Functions", "Matrices", "Determinants",
                        "Continuity and Differentiability", "Application of Derivatives"
                    ]
                },
                { 
                    title: "Mathematics Part II", 
                    code: "lemh2", 
                    cover: "blue",
                    chapters: [
                        "Integrals", "Application of Integrals", "Differential Equations", "Vector Algebra",
                        "Three Dimensional Geometry", "Linear Programming", "Probability"
                    ]
                },
                { 
                    title: "Biology", 
                    code: "lebo1", 
                    cover: "green",
                    chapters: [
                        "Sexual Reproduction in Flowering Plants", "Human Reproduction", "Reproductive Health", "Principles of Inheritance and Variation",
                        "Molecular Basis of Inheritance", "Evolution", "Human Health and Disease", "Microbes in Human Welfare",
                        "Biotechnology: Principles and Processes", "Biotechnology and its Applications", "Organisms and Populations", "Ecosystem",
                        "Biodiversity and Conservation"
                    ]
                },
                { title: "Physics Part I", code: "leph1", count: 8, cover: "indigo" },
                { title: "Physics Part II", code: "leph2", count: 7, cover: "indigo" },
                { title: "Chemistry Part I", code: "lech1", count: 9, cover: "teal" },
                { title: "Chemistry Part II", code: "lech2", count: 7, cover: "teal" },
                { title: "Flamingo (English)", code: "lefl1", count: 8, cover: "orange" },
                { title: "Vistas (English)", code: "levt1", count: 8, cover: "orange" },
            ]
        };

        // Light mode colors matching the requested logo (Red/Yellow theme)
        const COLOR_MAP = {
            blue: "bg-blue-50 text-blue-700 border-blue-100",
            emerald: "bg-emerald-50 text-emerald-700 border-emerald-100",
            orange: "bg-orange-50 text-orange-700 border-orange-100",
            red: "bg-red-50 text-red-700 border-red-100",
            yellow: "bg-yellow-50 text-yellow-700 border-yellow-100",
            pink: "bg-pink-50 text-pink-700 border-pink-100",
            purple: "bg-purple-50 text-purple-700 border-purple-100",
            indigo: "bg-indigo-50 text-indigo-700 border-indigo-100",
            teal: "bg-teal-50 text-teal-700 border-teal-100",
            green: "bg-green-50 text-green-700 border-green-100",
        };

        // --- Login Page Component ---
        function LoginPage({ onLogin }) {
            const [error, setError] = useState("");
            const [isLoading, setIsLoading] = useState(false);

            // Firebase is available globally via window.firebaseAuth and window.firebaseDb

            const handleGoogleSignIn = async () => {
                setError("");
                setIsLoading(true);
                
                try {
                    const auth = window.firebaseAuth;
                    const db = window.firebaseDb;
                    const provider = new firebase.auth.GoogleAuthProvider();
                    
                    // Sign in with Google
                    const result = await auth.signInWithPopup(provider);
                    const user = result.user;
                    
                    // Check if this is a new user
                    const isNewUser = result.additionalUserInfo.isNewUser;
                    
                    // Get user data
                    const displayName = user.displayName || user.email?.split('@')[0] || 'User';
                    const email = user.email || '';
                    const photoURL = user.photoURL || '';
                    const phoneNumber = user.phoneNumber || '';
                    
                    // Store in localStorage
                    localStorage.setItem('username', displayName);
                    localStorage.setItem('userEmail', email);
                    localStorage.setItem('userId', user.uid);
                    if (photoURL) localStorage.setItem('userPhoto', photoURL);
                    if (phoneNumber) localStorage.setItem('userPhone', phoneNumber);
                    
                    if (isNewUser) {
                        // New user signup
                        localStorage.setItem('isNewUser', 'true');
                        
                        // Store user data in Firestore
                        const userData = {
                            username: displayName,
                            displayName: displayName,
                            name: displayName,
                            email: email,
                            phone: phoneNumber,
                            photoURL: photoURL,
                            class: '', // Will be set in profile
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        try {
                            await db.collection("users").doc(user.uid).set(userData);
                            console.log("✅ New user data saved to Firestore:", user.uid);
                        } catch (firestoreError) {
                            console.error("❌ Error saving to Firestore:", firestoreError);
                            // Continue even if Firestore fails - data is in localStorage
                        }
                        
                        // Redirect to profile page for new users
                        onLogin(displayName, true);
                    } else {
                        // Existing user login
                        const userDoc = await db.collection("users").doc(user.uid).get();
                        let finalDisplayName = displayName;
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            finalDisplayName = userData.username || userData.displayName || userData.name || displayName;
                            
                            // Update last login and sync data
                            try {
                                await db.collection("users").doc(user.uid).update({
                                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                                    email: email,
                                    photoURL: photoURL,
                                    displayName: displayName
                                });
                                console.log("✅ Last login updated in Firestore");
                            } catch (err) {
                                console.error("❌ Error updating last login:", err);
                            }
                        } else {
                            // Create user doc if doesn't exist
                            const newUserData = {
                                username: displayName,
                                displayName: displayName,
                                name: displayName,
                                email: email,
                                phone: phoneNumber,
                                photoURL: photoURL,
                                class: '',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            try {
                                await db.collection("users").doc(user.uid).set(newUserData);
                                console.log("✅ User data saved to Firestore:", user.uid);
                            } catch (firestoreError) {
                                console.error("❌ Error saving user to Firestore:", firestoreError);
                            }
                        }
                        
                        // Update localStorage
                        localStorage.setItem('username', finalDisplayName);
                        localStorage.setItem('userEmail', email);
                        if (photoURL) localStorage.setItem('userPhoto', photoURL);
                        
                        // Redirect to home
                        onLogin(finalDisplayName, false);
                    }
                } catch (error) {
                    setIsLoading(false);
                    console.error("Google Sign-In error:", error);
                    
                    let errorMessage = "Failed to sign in with Google. Please try again.";
                    
                    if (error.code === "auth/popup-closed-by-user") {
                        errorMessage = "Sign-in was cancelled. Please try again.";
                    } else if (error.code === "auth/popup-blocked") {
                        errorMessage = "Popup was blocked. Please allow popups and try again.";
                    } else if (error.code === "auth/operation-not-allowed") {
                        errorMessage = "Google sign-in is not enabled. Please contact administrator.";
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    setError(errorMessage);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-50 via-red-50 to-yellow-50 px-4 py-8">
                    <div className="w-full max-w-md animate-in fade-in slide-in-from-bottom-8 duration-500">
                        {/* Logo and Title Section */}
                        <div className="text-center mb-8">
                            <div className="flex justify-center mb-6">
                                <div className="w-24 h-24 flex items-center justify-center overflow-hidden bg-white rounded-full shadow-lg p-3">
                                    <img src="img/logo.png" alt="Chaturvedi Classes Logo" className="w-full h-full object-contain" />
                                </div>
                            </div>
                            <h1 className="text-3xl md:text-4xl font-bold text-red-900 mb-2">
                                Chaturvedi <span className="text-yellow-600">Classes</span>
                            </h1>
                            <p className="text-sm text-gray-600 font-semibold tracking-wider uppercase">Excellence in Education</p>
                        </div>

                        {/* Login Card */}
                        <div className="bg-white rounded-3xl border border-gray-200 shadow-2xl p-8 md:p-10">
                            {/* Welcome Message */}
                            <div className="text-center mb-8">
                                <h2 className="text-2xl font-bold text-gray-900 mb-2">Welcome Back!</h2>
                                <p className="text-gray-600 text-sm">Sign in to continue your learning journey</p>
                            </div>

                            {/* Error Message */}
                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl text-sm mb-6">
                                    {error}
                                </div>
                            )}

                            {/* Google Sign-In Button */}
                            <button
                                onClick={handleGoogleSignIn}
                                disabled={isLoading}
                                className="w-full bg-white border-2 border-gray-300 text-gray-700 py-4 rounded-xl font-semibold text-base hover:bg-gray-50 hover:border-gray-400 transition-all duration-300 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 group"
                            >
                                {isLoading ? (
                                    <>
                                        <div className="w-5 h-5 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>
                                        <span>Signing in...</span>
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-5 h-5" viewBox="0 0 24 24">
                                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                        </svg>
                                        <span>Continue with Google</span>
                                    </>
                                )}
                            </button>

                            {/* Divider */}
                            <div className="relative my-6">
                                <div className="absolute inset-0 flex items-center">
                                    <div className="w-full border-t border-gray-300"></div>
                                </div>
                                <div className="relative flex justify-center text-sm">
                                    <span className="px-4 bg-white text-gray-500">Quick & Secure</span>
                                </div>
                            </div>

                            {/* Info Section */}
                            <div className="mt-6 space-y-3">
                                <div className="flex items-start gap-3 text-sm text-gray-600">
                                    <svg className="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span>No password required</span>
                                </div>
                                <div className="flex items-start gap-3 text-sm text-gray-600">
                                    <svg className="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                    </svg>
                                    <span>Secure authentication</span>
                                </div>
                                <div className="flex items-start gap-3 text-sm text-gray-600">
                                    <svg className="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                    <span>Instant access</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Profile Edit Page Component ---
        function ProfileEditPage({ onBackToHome, username, onUsernameUpdate }) {
            const [displayName, setDisplayName] = useState(username || '');
            const [selectedClass, setSelectedClass] = useState('');
            const [email, setEmail] = useState('');
            const [phone, setPhone] = useState('');
            const [isSaving, setIsSaving] = useState(false);
            const [message, setMessage] = useState({ type: '', text: '' });

            useEffect(() => {
                const loadUserData = async () => {
                    try {
                        const auth = window.firebaseAuth;
                        const db = window.firebaseDb;
                        const user = auth.currentUser;

                        if (user) {
                            setEmail(user.email || '');
                            
                            // Get phone from localStorage or Firestore
                            const cachedPhone = localStorage.getItem('userPhone') || '';
                            setPhone(cachedPhone);
                            
                            // Get user data from Firestore
                            try {
                                const userDoc = await db.collection("users").doc(user.uid).get();
                                if (userDoc.exists) {
                                    const userData = userDoc.data();
                                    setDisplayName(userData.username || userData.displayName || username || '');
                                    setSelectedClass(userData.class || '');
                                    setEmail(userData.email || user.email || '');
                                    setPhone(userData.phone || cachedPhone || '');
                                    console.log("✅ Profile data loaded from Firestore:", userData);
                                } else {
                                    setDisplayName(username || '');
                                    console.log("⚠️ User doc not found in Firestore, using cached data");
                                }
                            } catch (error) {
                                console.error("❌ Error loading profile data from Firestore:", error);
                                console.error("Error details:", {
                                    code: error.code,
                                    message: error.message
                                });
                                // Use cached data if Firestore fails
                                setDisplayName(username || '');
                            }
                        }
                    } catch (error) {
                        console.error("Error loading user data:", error);
                        setDisplayName(username || '');
                    }
                };

                loadUserData();
            }, [username]);

            const handleSave = async () => {
                if (!displayName.trim()) {
                    setMessage({ type: 'error', text: 'Please enter your name' });
                    return;
                }

                // Check if class is selected (mandatory)
                if (!selectedClass) {
                    setMessage({ type: 'error', text: 'Please select your class' });
                    return;
                }
                
                // Validate email format if provided
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    setMessage({ type: 'error', text: 'Please enter a valid email address' });
                    return;
                }

                setIsSaving(true);
                setMessage({ type: '', text: '' });

                try {
                    const auth = window.firebaseAuth;
                    const db = window.firebaseDb;
                    const user = auth.currentUser;

                    if (!user) {
                        setMessage({ type: 'error', text: 'User not authenticated. Please login again.' });
                        setIsSaving(false);
                        return;
                    }

                    // Get existing user data
                    const userDoc = await db.collection("users").doc(user.uid).get();
                    const existingData = userDoc.exists ? userDoc.data() : {};
                    
                    // Check if this is a new user
                    const isNewUser = localStorage.getItem('isNewUser') === 'true';
                    
                    // Prepare user data with all required fields
                    const userData = {
                        name: displayName,
                        username: displayName,
                        displayName: displayName,
                        class: selectedClass,
                        email: email || existingData.email || '',
                        phone: existingData.phone || localStorage.getItem('userPhone') || '',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // If new user, preserve creation timestamp
                    if (isNewUser) {
                        if (existingData.createdAt) {
                            userData.createdAt = existingData.createdAt;
                        } else {
                            userData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        }
                    } else if (existingData.createdAt) {
                        // Preserve existing creation timestamp for existing users
                        userData.createdAt = existingData.createdAt;
                    }

                    // Update Firestore with all data
                    try {
                        await db.collection("users").doc(user.uid).set(userData, { merge: true });
                        console.log("✅ Profile data saved to Firestore successfully:", user.uid);
                        console.log("Saved data:", userData);
                    } catch (firestoreError) {
                        console.error("❌ Error saving profile to Firestore:", firestoreError);
                        console.error("Error details:", {
                            code: firestoreError.code,
                            message: firestoreError.message
                        });
                        throw firestoreError; // Re-throw to be caught by outer catch
                    }

                    // Update localStorage
                    localStorage.setItem('username', displayName);
                    localStorage.removeItem('isNewUser'); // Remove flag after first save
                    
                    // Update parent component username
                    if (onUsernameUpdate) {
                        onUsernameUpdate(displayName);
                    }
                    
                    setMessage({ type: 'success', text: 'Profile updated successfully!' });
                    
                    // Redirect to home after save
                    setTimeout(() => {
                        onBackToHome();
                    }, 1500);
                } catch (error) {
                    console.error("Error updating profile:", error);
                    console.error("Error details:", {
                        code: error.code,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    let errorMessage = 'Failed to update profile. Please try again.';
                    
                    // Provide more specific error messages
                    if (error.code === 'permission-denied') {
                        errorMessage = 'Permission denied. Please check your Firebase security rules.';
                    } else if (error.code === 'unavailable') {
                        errorMessage = 'Service temporarily unavailable. Please check your internet connection.';
                    } else if (error.message) {
                        errorMessage = `Error: ${error.message}`;
                    }
                    
                    setMessage({ type: 'error', text: errorMessage });
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col font-sans bg-gray-50 text-gray-900">
                    {/* Header */}
                    <header className="bg-white border-b border-gray-200 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center gap-3 select-none">
                                    <div className="w-10 h-10 flex items-center justify-center overflow-hidden">
                                        <img src="img/logo.png" alt="Chaturvedi Classes Logo" className="w-full h-full object-contain" />
                                    </div>
                                    <div>
                                        <h1 className="text-lg md:text-xl font-bold text-red-900 leading-tight">Chaturvedi <span className="text-yellow-600">Classes</span></h1>
                                        <p className="text-[10px] md:text-xs text-gray-500 font-semibold tracking-wider">EXCELLENCE IN EDUCATION</p>
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={onBackToHome}
                                    className="p-2 text-gray-600 hover:text-red-700 transition-colors rounded-lg hover:bg-gray-100"
                                >
                                    <ArrowLeft className="w-6 h-6" />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 max-w-2xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
                        <div className="animate-in fade-in slide-in-from-bottom-8 duration-500">
                            <div className="bg-white rounded-2xl border border-gray-200 shadow-xl p-6 md:p-8">
                                <h2 className="text-2xl md:text-3xl font-bold text-gray-900 mb-6">Edit Profile</h2>

                                {/* Message */}
                                {message.text && (
                                    <div className={`mb-6 px-4 py-3 rounded-xl text-sm ${
                                        message.type === 'success' 
                                            ? 'bg-green-50 border border-green-200 text-green-700' 
                                            : 'bg-red-50 border border-red-200 text-red-700'
                                    }`}>
                                        {message.text}
                                    </div>
                                )}

                                <div className="space-y-6">
                                    {/* Name Field */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Name <span className="text-red-500">*</span>
                                        </label>
                                        <div className="relative">
                                            <User className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                                            <input
                                                type="text"
                                                value={displayName}
                                                onChange={(e) => setDisplayName(e.target.value)}
                                                className="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all"
                                                placeholder="Enter your name"
                                            />
                                        </div>
                                    </div>

                                    {/* Class Selection */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Class <span className="text-red-500">*</span>
                                        </label>
                                        <select
                                            value={selectedClass}
                                            onChange={(e) => setSelectedClass(e.target.value)}
                                            className="w-full pl-4 pr-4 py-3 border border-gray-200 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all"
                                        >
                                            <option value="">Select your class</option>
                                            <option value="9">Class 9th</option>
                                            <option value="10">Class 10th</option>
                                            <option value="11">Class 11th</option>
                                            <option value="12">Class 12th</option>
                                        </select>
                                    </div>

                                    {/* Email Field (Editable) */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Email
                                        </label>
                                        <div className="relative">
                                            <svg className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                            </svg>
                                            <input
                                                type="email"
                                                value={email}
                                                onChange={(e) => setEmail(e.target.value)}
                                                className="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all"
                                                placeholder="Enter your email"
                                            />
                                        </div>
                                    </div>

                                    {/* Phone Field (Display only) */}
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Phone Number
                                        </label>
                                        <div className="relative">
                                            <Phone className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                                            <input
                                                type="text"
                                                value={phone}
                                                readOnly
                                                className="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl text-gray-500 bg-gray-50 cursor-not-allowed"
                                                placeholder="Phone number"
                                            />
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">Phone number cannot be changed</p>
                                    </div>

                                    {/* Save Button */}
                                    <div className="flex gap-4 pt-4">
                                        <button
                                            onClick={handleSave}
                                            disabled={isSaving}
                                            className="flex-1 bg-red-700 text-white py-3 rounded-xl font-bold text-lg hover:bg-red-800 transition-all duration-300 shadow-md shadow-red-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                        >
                                            {isSaving ? (
                                                <>
                                                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                    <span>Saving...</span>
                                                </>
                                            ) : (
                                                "Save Changes"
                                            )}
                                        </button>
                                        <button
                                            onClick={onBackToHome}
                                            className="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-all duration-300"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        // --- Home Page Component ---
        function HomePage({ onNavigateToLibrary, username, onLogout, onNavigateToProfile }) {
            const [isNavOpen, setIsNavOpen] = useState(false);
            const [profilePicture, setProfilePicture] = useState(localStorage.getItem('profilePicture') || '');

            const toggleNav = () => {
                setIsNavOpen(!isNavOpen);
            };

            const closeNav = () => {
                setIsNavOpen(false);
            };

            // Handle profile picture upload
            const handleProfilePictureUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file');
                        return;
                    }
                    
                    // Validate file size (max 2MB)
                    if (file.size > 2 * 1024 * 1024) {
                        alert('Image size should be less than 2MB');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageData = event.target.result;
                        // Store in localStorage
                        localStorage.setItem('profilePicture', imageData);
                        setProfilePicture(imageData);
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Trigger file input when user icon is clicked
            const handleUserIconClick = () => {
                document.getElementById('profile-picture-input').click();
            };

            return (
                <div className="min-h-screen flex flex-col font-sans bg-gray-50 text-gray-900">
                    {/* Header */}
                    <header className="bg-white border-b border-gray-200 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center gap-3 select-none">
                                    <div className="w-10 h-10 flex items-center justify-center overflow-hidden">
                                        <img src="img/logo.png" alt="Chaturvedi Classes Logo" className="w-full h-full object-contain" />
                                    </div>
                                    <div>
                                        <h1 className="text-lg md:text-xl font-bold text-red-900 leading-tight">Chaturvedi <span className="text-yellow-600">Classes</span></h1>
                                        <p className="text-[10px] md:text-xs text-gray-500 font-semibold tracking-wider">EXCELLENCE IN EDUCATION</p>
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-4">
                                    <button 
                                        onClick={toggleNav}
                                        className="p-2 text-gray-600 hover:text-red-700 transition-colors rounded-lg hover:bg-gray-100"
                                        aria-label="Open navigation menu"
                                    >
                                        <Menu className="w-6 h-6" />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Navigation Drawer */}
                    <div 
                        className={`fixed inset-0 z-50 transition-opacity duration-300 ${isNavOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}
                        onClick={closeNav}
                    >
                        {/* Backdrop */}
                        <div className="absolute inset-0 bg-black/50"></div>
                        
                        {/* Drawer */}
                        <div 
                            className={`absolute right-0 top-0 h-full w-80 max-w-[85vw] bg-white shadow-2xl transform transition-transform duration-300 ease-out ${isNavOpen ? 'translate-x-0' : 'translate-x-full'}`}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <div className="flex flex-col h-full">
                                {/* Drawer Header */}
                                <div className="flex items-center justify-between p-6 border-b border-gray-200">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 flex items-center justify-center overflow-hidden">
                                            <img src="img/logo.png" alt="Chaturvedi Classes Logo" className="w-full h-full object-contain" />
                                        </div>
                                        <div>
                                            <h2 className="text-lg font-bold text-red-900">{username}</h2>
                                            <p className="text-xs text-gray-500">Chaturvedi Classes</p>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={closeNav}
                                        className="p-2 text-gray-400 hover:text-gray-600 transition-colors rounded-lg hover:bg-gray-100"
                                        aria-label="Close menu"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>

                                {/* Navigation Items */}
                                <div className="flex-1 overflow-y-auto py-4">
                                    <nav className="space-y-1 px-4">
                                        <button
                                            onClick={() => { closeNav(); onNavigateToProfile(); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-left text-gray-700 hover:bg-yellow-50 hover:text-red-700 rounded-xl transition-colors group"
                                        >
                                            <User className="w-5 h-5 text-gray-400 group-hover:text-red-700" />
                                            <span className="font-medium">Profile</span>
                                        </button>
                                        
                                        <button
                                            onClick={() => { closeNav(); onNavigateToLibrary(); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-left text-gray-700 hover:bg-yellow-50 hover:text-red-700 rounded-xl transition-colors group"
                                        >
                                            <Library className="w-5 h-5 text-gray-400 group-hover:text-red-700" />
                                            <span className="font-medium">NCERT Library</span>
                                        </button>
                                        
                                        <button
                                            onClick={() => { closeNav(); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-left text-gray-700 hover:bg-yellow-50 hover:text-red-700 rounded-xl transition-colors group"
                                        >
                                            <Book className="w-5 h-5 text-gray-400 group-hover:text-red-700" />
                                            <span className="font-medium">My Books</span>
                                        </button>
                                        
                                        <button
                                            onClick={() => { closeNav(); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-left text-gray-700 hover:bg-yellow-50 hover:text-red-700 rounded-xl transition-colors group"
                                        >
                                            <GraduationCap className="w-5 h-5 text-gray-400 group-hover:text-red-700" />
                                            <span className="font-medium">Classes</span>
                                        </button>
                                        
                                        <div className="border-t border-gray-200 my-2"></div>
                                        
                                        <button
                                            onClick={() => { closeNav(); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-left text-gray-700 hover:bg-yellow-50 hover:text-red-700 rounded-xl transition-colors group"
                                        >
                                            <svg className="w-5 h-5 text-gray-400 group-hover:text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            </svg>
                                            <span className="font-medium">Settings</span>
                                        </button>
                                        
                                        <div className="border-t border-gray-200 my-2"></div>
                                        
                                        {/* More Apps Section */}
                                        <button
                                            onClick={() => { 
                                                closeNav(); 
                                                window.open('https://play.google.com/store/apps/dev?id=8205647922049206296', '_blank');
                                            }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-left text-gray-700 hover:bg-yellow-50 hover:text-red-700 rounded-xl transition-colors group"
                                        >
                                            <Grid className="w-5 h-5 text-gray-400 group-hover:text-red-700" />
                                            <span className="font-medium">More Apps</span>
                                        </button>
                                        
                                        <button
                                            onClick={() => { closeNav(); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-left text-gray-700 hover:bg-yellow-50 hover:text-red-700 rounded-xl transition-colors group"
                                        >
                                            <Star className="w-5 h-5 text-gray-400 group-hover:text-red-700" />
                                            <span className="font-medium">Rate App</span>
                                        </button>
                                        
                                        <button
                                            onClick={() => { closeNav(); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-left text-gray-700 hover:bg-yellow-50 hover:text-red-700 rounded-xl transition-colors group"
                                        >
                                            <Share2 className="w-5 h-5 text-gray-400 group-hover:text-red-700" />
                                            <span className="font-medium">Share App</span>
                                        </button>
                                        
                                        <button
                                            onClick={() => { closeNav(); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-left text-gray-700 hover:bg-yellow-50 hover:text-red-700 rounded-xl transition-colors group"
                                        >
                                            <MapPin className="w-5 h-5 text-gray-400 group-hover:text-red-700" />
                                            <span className="font-medium">Location</span>
                                        </button>
                                        
                                        <button
                                            onClick={() => { closeNav(); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 text-left text-gray-700 hover:bg-yellow-50 hover:text-red-700 rounded-xl transition-colors group"
                                        >
                                            <FileText className="w-5 h-5 text-gray-400 group-hover:text-red-700" />
                                            <span className="font-medium">Privacy Policy</span>
                                        </button>
                                    </nav>
                                </div>

                                {/* Logout Button at Bottom */}
                                <div className="border-t border-gray-200 p-4">
                                    <button
                                        onClick={() => { closeNav(); onLogout(); }}
                                        className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-50 text-red-700 rounded-xl font-semibold hover:bg-red-100 transition-colors"
                                    >
                                        <LogOut className="w-5 h-5" />
                                        <span>Logout</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <main className="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
                        <div className="animate-in fade-in slide-in-from-bottom-8 duration-500">
                            {/* Username Card */}
                            <div className="bg-gradient-to-r from-red-50 to-yellow-50 rounded-2xl border border-red-100 p-6 mb-8 relative overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-300">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                        <div 
                                            onClick={handleUserIconClick}
                                            className="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-sm cursor-pointer hover:shadow-md transition-all overflow-hidden"
                                            title="Click to change profile picture"
                                        >
                                            {profilePicture ? (
                                                <img src={profilePicture} alt="Profile" className="w-full h-full object-cover rounded-full" />
                                            ) : (
                                                <User className="w-8 h-8 text-red-700" />
                                            )}
                                        </div>
                                        <div>
                                            <h2 className="text-2xl md:text-3xl font-bold text-gray-900">
                                                Hey, <span className="text-red-700">{username}</span>
                                            </h2>
                                            <p className="text-sm text-gray-600 mt-1">Ready to learn today?</p>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={onNavigateToProfile}
                                        className="p-2 text-gray-400 hover:text-red-700 hover:bg-white/50 rounded-lg transition-all duration-300"
                                        aria-label="Edit profile"
                                        title="Edit profile"
                                    >
                                        <Edit className="w-5 h-5" />
                                    </button>
                                </div>
                                {/* Hidden file input for profile picture */}
                                <input
                                    id="profile-picture-input"
                                    type="file"
                                    accept="image/*"
                                    onChange={handleProfilePictureUpload}
                                    style={{ display: 'none' }}
                                />
                            </div>

                            {/* Quick Actions - Horizontal Scrollable */}
                            <div className="mb-8">
                                <h3 className="text-lg font-bold text-gray-900 mb-4">Quick Actions</h3>
                                <div className="relative">
                                    <div className="overflow-x-auto scrollbar-hide scroll-smooth" style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}>
                                        <div className="flex gap-4 pb-2" style={{ width: 'max-content' }}>
                                            <a 
                                                href="tel:+1234567890"
                                                className="flex-shrink-0 flex flex-col items-center justify-center gap-2 w-24 h-24 bg-white rounded-2xl border border-gray-200 shadow-sm hover:shadow-md hover:border-red-300 transition-all duration-300 group"
                                            >
                                                <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center group-hover:bg-red-200 transition-colors">
                                                    <Phone className="w-6 h-6 text-red-700" />
                                                </div>
                                                <span className="text-xs font-semibold text-gray-700 text-center">Help</span>
                                            </a>
                                            
                                            <button
                                                onClick={() => {/* Handle notifications */}}
                                                className="flex-shrink-0 flex flex-col items-center justify-center gap-2 w-24 h-24 bg-white rounded-2xl border border-gray-200 shadow-sm hover:shadow-md hover:border-yellow-300 transition-all duration-300 group relative"
                                            >
                                                <div className="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center group-hover:bg-yellow-200 transition-colors relative">
                                                    <Bell className="w-6 h-6 text-yellow-700" />
                                                    {/* Notification badge */}
                                                    <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                                                </div>
                                                <span className="text-xs font-semibold text-gray-700 text-center">Notifications</span>
                                            </button>
                                            
                                            <button
                                                onClick={() => {/* Handle Ask AI */}}
                                                className="flex-shrink-0 flex flex-col items-center justify-center gap-2 w-24 h-24 bg-white rounded-2xl border border-gray-200 shadow-sm hover:shadow-md hover:border-red-300 transition-all duration-300 group"
                                            >
                                                <div className="w-12 h-12 bg-gradient-to-br from-red-100 to-yellow-100 rounded-full flex items-center justify-center group-hover:from-red-200 group-hover:to-yellow-200 transition-colors">
                                                    <Sparkles className="w-6 h-6 text-red-700" />
                                                </div>
                                                <span className="text-xs font-semibold text-gray-700 text-center">Ask AI</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Feature Cards - Grid Layout */}
                            <div className="mb-8">
                                <h3 className="text-lg font-bold text-gray-900 mb-4">Features</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div 
                                        onClick={onNavigateToLibrary}
                                        className="bg-white rounded-2xl border border-gray-200 p-6 hover:shadow-xl hover:shadow-gray-200/50 hover:border-red-400 transition-all duration-300 cursor-pointer group"
                                    >
                                        <div className="w-14 h-14 bg-gradient-to-br from-red-50 to-yellow-50 rounded-xl flex items-center justify-center mb-4 group-hover:from-red-100 group-hover:to-yellow-100 transition-colors">
                                            <Book className="w-7 h-7 text-red-700" />
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-900 mb-2">NCERT Books</h3>
                                        <p className="text-sm text-gray-600">Access all NCERT textbooks for classes 9-12</p>
                                    </div>
                                    
                                    <div 
                                        onClick={onNavigateToLibrary}
                                        className="bg-white rounded-2xl border border-gray-200 p-6 hover:shadow-xl hover:shadow-gray-200/50 hover:border-red-400 transition-all duration-300 cursor-pointer group"
                                    >
                                        <div className="w-14 h-14 bg-gradient-to-br from-red-50 to-yellow-50 rounded-xl flex items-center justify-center mb-4 group-hover:from-red-100 group-hover:to-yellow-100 transition-colors">
                                            <GraduationCap className="w-7 h-7 text-red-700" />
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-900 mb-2">All Classes</h3>
                                        <p className="text-sm text-gray-600">Study materials for 9th, 10th, 11th, and 12th</p>
                                    </div>
                                    
                                    <div 
                                        onClick={onNavigateToLibrary}
                                        className="bg-white rounded-2xl border border-gray-200 p-6 hover:shadow-xl hover:shadow-gray-200/50 hover:border-red-400 transition-all duration-300 cursor-pointer group"
                                    >
                                        <div className="w-14 h-14 bg-gradient-to-br from-red-50 to-yellow-50 rounded-xl flex items-center justify-center mb-4 group-hover:from-red-100 group-hover:to-yellow-100 transition-colors">
                                            <Download className="w-7 h-7 text-red-700" />
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-900 mb-2">Easy Download</h3>
                                        <p className="text-sm text-gray-600">Download PDFs instantly for offline study</p>
                                    </div>
                                </div>
                            </div>

                            {/* CTA Button - Large Prominent */}
                            <div className="mb-8">
                                <button
                                    onClick={onNavigateToLibrary}
                                    className="w-full group flex items-center justify-center gap-3 px-8 py-5 bg-gradient-to-r from-red-700 to-red-600 text-white rounded-2xl font-bold text-lg hover:from-red-800 hover:to-red-700 transition-all duration-300 shadow-lg shadow-red-200 hover:shadow-xl hover:shadow-red-300"
                                >
                                    <Library className="w-6 h-6" />
                                    <span>Enter NCERT Library</span>
                                    <ChevronRight className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
                                </button>
                            </div>
                        </div>
                    </main>

                </div>
            );
        }

        // --- NCERT Library Component (Existing Code - Unchanged) ---
        function NCERTLibrary({ onBackToHome }) {
            const [selectedClass, setSelectedClass] = useState(10);
            const [selectedBook, setSelectedBook] = useState(null);
            const [searchQuery, setSearchQuery] = useState("");

            const getChapterUrl = (bookCode, chapterNum) => {
                const paddedNum = chapterNum.toString().padStart(2, '0');
                return `https://ncert.nic.in/textbook/pdf/${bookCode}${paddedNum}.pdf`;
            };

            const handleClassChange = (cls) => {
                setSelectedClass(cls);
                setSelectedBook(null);
            };

            const filteredBooks = NCERT_DATA[selectedClass].filter(book => 
                book.title.toLowerCase().includes(searchQuery.toLowerCase())
            );

            const getChapterCount = (book) => {
                return book.chapters ? book.chapters.length : book.count;
            };

            return (
                <div className="min-h-screen flex flex-col font-sans bg-gray-50 text-gray-900">
                    {/* Header - Optimized for Mobile */}
                    <header className="bg-white border-b border-gray-200 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center gap-3 select-none">
                                    {/* Logo Area */}
                                    <div className="w-10 h-10 flex items-center justify-center overflow-hidden">
                                        <img src="img/logo.png" alt="Chaturvedi Classes Logo" className="w-full h-full object-contain" />
                                    </div>
                                    <div>
                                        <h1 className="text-lg md:text-xl font-bold text-red-900 leading-tight">Chaturvedi <span className="text-yellow-600">Classes</span></h1>
                                        <p className="text-[10px] md:text-xs text-gray-500 font-semibold tracking-wider">EXCELLENCE IN EDUCATION</p>
                                    </div>
                                </div>
                                
                                {/* Desktop Nav */}
                                <div className="hidden md:flex items-center gap-6">
                                    <button 
                                        onClick={onBackToHome}
                                        className="text-gray-600 hover:text-red-700 font-medium text-sm transition-colors"
                                    >
                                        Home
                                    </button>
                                </div>

                                {/* Mobile Back Button */}
                                <button 
                                    onClick={onBackToHome}
                                    className="md:hidden text-gray-600 hover:text-red-700 transition-colors"
                                >
                                    <ArrowLeft className="w-6 h-6" />
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-8">
                        
                        {/* Class Selector - Horizontal Scroll on Mobile */}
                        {!selectedBook && (
                        <div className="mb-8 animate-in fade-in slide-in-from-top-4 duration-500">
                            <h2 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Select Class</h2>
                            <div className="flex flex-nowrap overflow-x-auto pb-4 md:pb-0 gap-3 scrollbar-hide -mx-4 px-4 md:mx-0 md:px-0">
                                {[9, 10, 11, 12].map((cls) => (
                                    <button
                                        key={cls}
                                        onClick={() => handleClassChange(cls)}
                                        className={`flex-shrink-0 flex items-center gap-2 px-6 py-3 rounded-xl font-bold transition-all duration-300 border ${
                                            selectedClass === cls
                                                ? 'bg-yellow-400 text-red-900 border-yellow-500 shadow-lg shadow-yellow-200 scale-105'
                                                : 'bg-white text-gray-600 border-gray-200 hover:border-yellow-300 hover:bg-yellow-50'
                                        }`}
                                    >
                                        <GraduationCap className={`w-5 h-5 ${selectedClass === cls ? 'text-red-900' : 'text-gray-400'}`} />
                                        <span className="whitespace-nowrap">Class {cls}th</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                        )}

                        {/* Content Area */}
                        {!selectedBook ? (
                            <div className="animate-in fade-in slide-in-from-bottom-8 duration-500">
                                {/* Search Bar Area */}
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                                    <div>
                                        <h2 className="text-2xl md:text-3xl font-bold text-gray-900 mb-1">
                                            Class {selectedClass} <span className="text-red-700">Library</span>
                                        </h2>
                                        <p className="text-gray-500 text-sm">Select a subject to begin learning</p>
                                    </div>
                                    <div className="relative w-full md:w-72">
                                        <Search className="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                                        <input 
                                            type="text" 
                                            placeholder="Search subjects..." 
                                            className="w-full bg-white pl-10 pr-4 py-3 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all shadow-sm"
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                        />
                                    </div>
                                </div>

                                {/* Books Grid */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                                    {filteredBooks.map((book) => (
                                        <div 
                                            key={book.code}
                                            onClick={() => setSelectedBook(book)}
                                            className="group bg-white rounded-2xl border border-gray-200 p-5 md:p-6 hover:shadow-xl hover:shadow-gray-200/50 hover:border-yellow-400 transition-all duration-300 cursor-pointer flex flex-col items-start relative overflow-hidden"
                                        >
                                            {/* Card Content */}
                                            <div className={`p-4 rounded-xl mb-4 ${COLOR_MAP[book.cover]} bg-opacity-30`}>
                                                <Book className="w-8 h-8" />
                                            </div>
                                            <h3 className="text-lg md:text-xl font-bold text-gray-900 mb-2 group-hover:text-red-700 transition-colors">{book.title}</h3>
                                            <p className="text-sm text-gray-500 mb-6">{getChapterCount(book)} Chapters</p>
                                            
                                            <div className="w-full mt-auto pt-4 border-t border-gray-100 flex justify-between items-center text-sm font-semibold text-red-700">
                                                <span>Open Book</span>
                                                <div className="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center group-hover:bg-red-100 transition-colors">
                                                    <ChevronRight className="w-4 h-4" />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="animate-in fade-in slide-in-from-right-8 duration-500">
                                {/* Book Header */}
                                <div className="mb-6 md:mb-8">
                                    <button 
                                        onClick={() => setSelectedBook(null)}
                                        className="flex items-center gap-2 text-gray-500 hover:text-red-700 mb-4 transition-colors group font-medium"
                                    >
                                        <ArrowLeft className="w-4 h-4 group-hover:-translate-x-1 transition-transform" />
                                        Back to Library
                                    </button>
                                    <div className="flex items-start justify-between bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                                        <div>
                                            <h2 className="text-2xl md:text-3xl font-bold text-gray-900 mb-2">{selectedBook.title}</h2>
                                            <div className="flex items-center gap-2">
                                                <span className="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-bold rounded">CLASS {selectedClass}</span>
                                                <span className="text-gray-500 text-sm">NCERT Official Edition</span>
                                            </div>
                                        </div>
                                        <div className={`hidden md:block p-4 rounded-xl ${COLOR_MAP[selectedBook.cover]}`}>
                                            <Book className="w-8 h-8" />
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Chapter List */}
                                <div className="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
                                    <div className="divide-y divide-gray-100">
                                        {Array.from({ length: getChapterCount(selectedBook) }, (_, i) => i + 1).map((chapterNum) => {
                                            const url = getChapterUrl(selectedBook.code, chapterNum);
                                            
                                            // Check if we have a real name, or fallback to generic
                                            const hasRealName = selectedBook.chapters && selectedBook.chapters[chapterNum - 1];
                                            const chapterName = hasRealName 
                                                ? selectedBook.chapters[chapterNum - 1] 
                                                : `Chapter ${chapterNum}`;

                                            return (
                                                <div key={chapterNum} className="p-4 md:p-6 hover:bg-gray-50 transition-colors flex flex-col md:flex-row md:items-center justify-between gap-4 group">
                                                    <div className="flex items-start md:items-center gap-4">
                                                        <div className="w-10 h-10 md:w-12 md:h-12 flex-shrink-0 rounded-xl bg-gray-100 text-gray-500 flex items-center justify-center font-bold text-lg group-hover:bg-yellow-400 group-hover:text-red-900 transition-all duration-300">
                                                            {chapterNum}
                                                        </div>
                                                        <div>
                                                            <h4 className="text-base md:text-lg font-bold text-gray-800 group-hover:text-red-700 transition-colors">
                                                                {chapterName}
                                                            </h4>
                                                            {/* Subtitle logic: Show nothing if we don't have a real name (to avoid 'PDF Document' clutter) */}
                                                            {hasRealName && (
                                                                <p className="text-xs md:text-sm text-gray-400 mt-1">
                                                                    Chapter {chapterNum}
                                                                </p>
                                                            )}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Action Buttons - Stacked on Mobile, Row on Desktop */}
                                                    <div className="flex items-center gap-2 md:gap-3 mt-2 md:mt-0 w-full md:w-auto">
                                                        <a 
                                                            href={url}
                                                            target="_blank"
                                                            rel="noreferrer"
                                                            className="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:border-red-600 hover:text-red-700 transition-all"
                                                        >
                                                            <ExternalLink className="w-4 h-4" />
                                                            View
                                                        </a>
                                                        <a 
                                                            href={url} 
                                                            download={`Class-${selectedClass}-${selectedBook.title}-Ch-${chapterNum}.pdf`}
                                                            target="_blank"
                                                            rel="noreferrer"
                                                            className="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2.5 bg-red-700 text-white rounded-lg text-sm font-semibold hover:bg-red-800 transition-all shadow-md shadow-red-200"
                                                        >
                                                            <Download className="w-4 h-4" />
                                                            Download
                                                        </a>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // --- Main App Component (Router) ---
        function App() {
            const [currentView, setCurrentView] = useState('login'); // 'login', 'home', 'library', 'profile'
            const [username, setUsername] = useState('');
            const [isCheckingAuth, setIsCheckingAuth] = useState(true);

            // Check authentication state on mount
            useEffect(() => {
                const checkAuthState = () => {
                    try {
                        const auth = window.firebaseAuth;
                        const db = window.firebaseDb;

                        firebase.auth().onAuthStateChanged((user) => {
                            if (user) {
                                // User is signed in - use cached data first (fast)
                                const cachedUsername = localStorage.getItem('username');
                                const displayName = cachedUsername || user.email.split('@')[0];
                                
                                // Update UI immediately with cached data
                                setUsername(displayName);
                                setCurrentView('home');
                                setIsCheckingAuth(false);
                                
                                // Fetch fresh data from Firestore in background (non-blocking)
                                db.collection("users").doc(user.uid).get().then(userDoc => {
                                    if (userDoc.exists) {
                                        const userData = userDoc.data();
                                        const fetchedName = userData.username || userData.displayName || displayName;
                                        
                                        // Update if different
                                        if (fetchedName !== displayName) {
                                            localStorage.setItem('username', fetchedName);
                                            setUsername(fetchedName);
                                        }
                                        console.log("✅ User data fetched from Firestore:", userData);
                                    } else {
                                        // Create user doc in background if doesn't exist
                                        const newUserData = {
                                            email: user.email || '',
                                            username: displayName,
                                            displayName: displayName,
                                            phone: user.phoneNumber || '',
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                                        };
                                        
                                        db.collection("users").doc(user.uid).set(newUserData)
                                            .then(() => {
                                                console.log("✅ User doc created in Firestore:", user.uid);
                                                console.log("Created data:", newUserData);
                                            })
                                            .catch(err => {
                                                console.error("❌ Error creating user doc:", err);
                                                console.error("Error details:", {
                                                    code: err.code,
                                                    message: err.message
                                                });
                                            });
                                    }
                                }).catch(err => {
                                    console.error("❌ Error fetching user data from Firestore:", err);
                                    console.error("Error details:", {
                                        code: err.code,
                                        message: err.message
                                    });
                                });
                            } else {
                                // User is signed out
                                setUsername('');
                                setCurrentView('login');
                                localStorage.removeItem('username');
                                localStorage.removeItem('userEmail');
                                localStorage.removeItem('userId');
                                setIsCheckingAuth(false);
                            }
                        });
                    } catch (error) {
                        console.error("Error checking auth state:", error);
                        setIsCheckingAuth(false);
                        // Fallback to localStorage
                        const savedUsername = localStorage.getItem('username');
                        if (savedUsername) {
                            setUsername(savedUsername);
                            setCurrentView('home');
                        }
                    }
                };

                // Wait for Firebase to be ready
                if (window.firebaseAuth) {
                    checkAuthState();
                } else {
                    // Wait a bit for Firebase to load
                    setTimeout(checkAuthState, 500);
                }
            }, []);

            // Internet connection detection
            useEffect(() => {
                // Save current URL to localStorage
                const saveCurrentUrl = () => {
                    const currentUrl = window.location.pathname.split('/').pop() || 'index.html';
                    localStorage.setItem('lastVisitedUrl', currentUrl);
                };

                // Check internet connectivity
                const checkInternet = async () => {
                    try {
                        const response = await fetch('https://www.google.com/favicon.ico?' + new Date().getTime(), {
                            method: 'HEAD',
                            mode: 'no-cors',
                            cache: 'no-cache'
                        });
                        return true;
                    } catch (error) {
                        return navigator.onLine;
                    }
                };

                // Handle offline event
                const handleOffline = async () => {
                    // Double check with actual fetch
                    const hasInternet = await checkInternet();
                    if (!hasInternet) {
                        saveCurrentUrl();
                        window.location.href = 'offline.html';
                    }
                };

                // Periodic check (every 5 seconds)
                const intervalCheck = setInterval(async () => {
                    if (!navigator.onLine) {
                        const hasInternet = await checkInternet();
                        if (!hasInternet) {
                            saveCurrentUrl();
                            window.location.href = 'offline.html';
                        }
                    }
                }, 5000);

                // Save URL on page load and navigation
                saveCurrentUrl();
                window.addEventListener('beforeunload', saveCurrentUrl);
                window.addEventListener('offline', handleOffline);

                return () => {
                    clearInterval(intervalCheck);
                    window.removeEventListener('beforeunload', saveCurrentUrl);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            const handleLogin = (user, isNewUser = false) => {
                setUsername(user);
                localStorage.setItem('username', user);
                
                // If new user, redirect to profile page
                if (isNewUser) {
                    setCurrentView('profile');
                } else {
                    setCurrentView('home');
                }
            };

            const handleLogout = async () => {
                try {
                    await firebase.auth().signOut();
                    setUsername('');
                    setCurrentView('login');
                    localStorage.removeItem('username');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userId');
                } catch (error) {
                    console.error("Error signing out:", error);
                    // Still logout locally even if Firebase signout fails
                    setUsername('');
                    setCurrentView('login');
                    localStorage.removeItem('username');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userId');
                }
            };

            const handleNavigateToLibrary = () => {
                setCurrentView('library');
            };

            const handleBackToHome = () => {
                setCurrentView('home');
            };

            const handleNavigateToProfile = () => {
                setCurrentView('profile');
            };

            // Show loading while checking authentication
            if (isCheckingAuth) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-red-700 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            // Render based on current view
            if (currentView === 'login') {
                return <LoginPage onLogin={handleLogin} />;
            } else if (currentView === 'home') {
                return <HomePage onNavigateToLibrary={handleNavigateToLibrary} username={username} onLogout={handleLogout} onNavigateToProfile={handleNavigateToProfile} />;
            } else if (currentView === 'library') {
                return <NCERTLibrary onBackToHome={handleBackToHome} />;
            } else if (currentView === 'profile') {
                return <ProfileEditPage onBackToHome={handleBackToHome} username={username} onUsernameUpdate={setUsername} />;
            }

            return null;
        }

        // Standard React initialization block
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
    </script>
</body>
</html>